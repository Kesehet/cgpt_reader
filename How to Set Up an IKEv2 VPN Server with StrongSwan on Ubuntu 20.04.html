<div class="Markdown_markdown__wHGCe"><p><em>A previous version of this tutorial was written by <a href="https://www.digitalocean.com/community/users/jellingwood">Justin Ellingwood</a> and <a href="https://www.digitalocean.com/community/users/namo">Namo</a></em></p>
<h3 id="introduction"><a href="#introduction" onclick="navigator.clipboard.writeText(this.href);">Introduction</a><a class="hash-anchor" href="#introduction" aria-hidden="true" onclick="navigator.clipboard.writeText(this.href);"></a></h3>
<p>A virtual private network, or VPN, allows you to securely encrypt traffic as it travels through untrusted networks, such as those at the coffee shop, a conference, or an airport.</p>
<p><a href="https://en.wikipedia.org/wiki/Internet_Key_Exchange">Internet Key Exchange v2</a>, or IKEv2, is a protocol that allows for direct IPSec tunneling between the server and client.  In IKEv2 VPN implementations, IPSec provides encryption for the network traffic.  IKEv2 is natively supported on some platforms (OS X 10.11+, iOS 9.1+, and Windows 10) with no additional applications necessary, and it handles client hiccups quite smoothly.</p>
<p>In this tutorial, you’ll set up an IKEv2 VPN server using <a href="https://www.strongswan.org/">StrongSwan</a> on an Ubuntu 20.04 server. You’ll then learn how to connect to it with Windows, macOS, Ubuntu, iOS, and Android clients.</p>
<h2 id="prerequisites"><a href="#prerequisites" onclick="navigator.clipboard.writeText(this.href);">Prerequisites</a><a class="hash-anchor" href="#prerequisites" aria-hidden="true" onclick="navigator.clipboard.writeText(this.href);"></a></h2>
<p>To complete this tutorial, you will need:</p>
<ul>
<li>One Ubuntu 20.04 server configured by following <a href="https://www.digitalocean.com/community/tutorials/initial-server-setup-with-ubuntu-20-04">the Ubuntu 20.04 initial server setup guide</a>, including a <code>sudo</code> non-root user and a firewall.</li>
</ul>
<h2 id="step-1-installing-strongswan"><a href="#step-1-installing-strongswan" onclick="navigator.clipboard.writeText(this.href);">Step 1 — Installing StrongSwan</a><a class="hash-anchor" href="#step-1-installing-strongswan" aria-hidden="true" onclick="navigator.clipboard.writeText(this.href);"></a></h2>
<p>First, we’ll install StrongSwan, an open-source IPSec daemon which we’ll configure as our VPN server.  We’ll also install the public key infrastructure (PKI) component so that we can create a Certificate Authority (CA) to provide credentials for our infrastructure.</p>
<p>Start by updating the local package cache:</p>
<div class="code-toolbar"><pre class="prefixed command language-bash"><code><ol><li data-prefix="$"><span class="token function">sudo</span> <span class="token function">apt</span> update
</li></ol>
</code></pre><div class="toolbar"><div class="toolbar-item"><button type="button">Copy</button></div></div></div>
<p>Then install the software by typing:</p>
<div class="code-toolbar"><pre class="prefixed command language-bash"><code><ol><li data-prefix="$"><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> strongswan strongswan-pki libcharon-extra-plugins libcharon-extauth-plugins libstrongswan-extra-plugins
</li></ol>
</code></pre><div class="toolbar"><div class="toolbar-item"><button type="button">Copy</button></div></div></div>
<p>The additional <code>libcharon-extauth-plugins</code> package is used to ensure that various clients can authenticate to your server using a shared username and passphrase. The <code>libstrongswan-extra-plugins</code> package is included so that Strongswan supports elliptic curve cipher suites that use the <code>Curve25519</code> cryptography suite.</p>
<p>Now that everything’s installed, let’s move on to creating our certificates.</p>
<h2 id="step-2-creating-a-certificate-authority"><a href="#step-2-creating-a-certificate-authority" onclick="navigator.clipboard.writeText(this.href);">Step 2 — Creating a Certificate Authority</a><a class="hash-anchor" href="#step-2-creating-a-certificate-authority" aria-hidden="true" onclick="navigator.clipboard.writeText(this.href);"></a></h2>
<p>An IKEv2 server requires a certificate to identify itself to clients.  To help create the required certificate, the <code>strongswan-pki</code> package comes with a utility called <code>pki</code> to generate a Certificate Authority and server certificates.</p>
<p>To begin, let’s create a few directories to store all the assets we’ll be working on.  The directory structure matches some of the directories in <code>/etc/ipsec.d</code>, where we will eventually move all of the items we create:</p>
<div class="code-toolbar"><pre class="prefixed command language-bash"><code><ol><li data-prefix="$"><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> ~/pki/<span class="token punctuation">{</span>cacerts,certs,private<span class="token punctuation">}</span>
</li></ol>
</code></pre><div class="toolbar"><div class="toolbar-item"><button type="button">Copy</button></div></div></div>
<p>Then lock down the permissions so that our private files can’t be seen by other users:</p>
<div class="code-toolbar"><pre class="prefixed command language-bash"><code><ol><li data-prefix="$"><span class="token function">chmod</span> <span class="token number">700</span> ~/pki
</li></ol>
</code></pre><div class="toolbar"><div class="toolbar-item"><button type="button">Copy</button></div></div></div>
<p>Now that we have a directory structure to store everything, we can generate a root key.  This will be a 4096-bit RSA key that will be used to sign our root certificate authority.</p>
<p>Execute these commands to generate the key:</p>
<div class="code-toolbar"><pre class="prefixed command language-bash"><code><ol><li data-prefix="$">pki <span class="token parameter variable">--gen</span> <span class="token parameter variable">--type</span> rsa <span class="token parameter variable">--size</span> <span class="token number">4096</span> <span class="token parameter variable">--outform</span> pem <span class="token operator">&gt;</span> ~/pki/private/ca-key.pem
</li></ol>
</code></pre><div class="toolbar"><div class="toolbar-item"><button type="button">Copy</button></div></div></div>
<p>Following that we can move on to creating our root certificate authority, using the key that we just generated to sign the root certificate:</p>
<div class="code-toolbar"><pre class="prefixed command language-bash"><code><ol><li data-prefix="$">pki <span class="token parameter variable">--self</span> <span class="token parameter variable">--ca</span> <span class="token parameter variable">--lifetime</span> <span class="token number">3650</span> <span class="token parameter variable">--in</span> ~/pki/private/ca-key.pem <span class="token punctuation">\</span>
</li><li data-prefix="$">    <span class="token parameter variable">--type</span> rsa <span class="token parameter variable">--dn</span> <span class="token string">"CN=VPN root CA"</span> <span class="token parameter variable">--outform</span> pem <span class="token operator">&gt;</span> ~/pki/cacerts/ca-cert.pem
</li></ol>
</code></pre><div class="toolbar"><div class="toolbar-item"><button type="button">Copy</button></div></div></div>
<p>The <code>--lifetime 3650</code> flag is used to ensure that the certificate authority’s root certificate will be valid for 10 years. The root certificate for an authority does not change typically, since it would have to be redistributed to every server and client that rely on it, so 10 years is a safe default expiry value.</p>
<p>You can change the <em>distinguished name</em> (DN) value to something else if you would like.  The common name (CN field) here is just the indicator, so it doesn’t have to match anything in your infrastructure.</p>
<p>Now that we’ve got our root certificate authority up and running, we can create a certificate that the VPN server will use.</p>
<h2 id="step-3-generating-a-certificate-for-the-vpn-server"><a href="#step-3-generating-a-certificate-for-the-vpn-server" onclick="navigator.clipboard.writeText(this.href);">Step 3 — Generating a Certificate for the VPN Server</a><a class="hash-anchor" href="#step-3-generating-a-certificate-for-the-vpn-server" aria-hidden="true" onclick="navigator.clipboard.writeText(this.href);"></a></h2>
<p>We’ll now create a certificate and key for the VPN server.  This certificate will allow the client to verify the server’s authenticity using the CA certificate we just generated.</p>
<p>First, create a private key for the VPN server with the following command:</p>
<div class="code-toolbar"><pre class="prefixed command language-bash"><code><ol><li data-prefix="$">pki <span class="token parameter variable">--gen</span> <span class="token parameter variable">--type</span> rsa <span class="token parameter variable">--size</span> <span class="token number">4096</span> <span class="token parameter variable">--outform</span> pem <span class="token operator">&gt;</span> ~/pki/private/server-key.pem
</li></ol>
</code></pre><div class="toolbar"><div class="toolbar-item"><button type="button">Copy</button></div></div></div>
<p>Now, create and sign the VPN server certificate with the certificate authority’s key you created in the previous step.  Execute the following command, but change the Common Name (CN) and the Subject Alternate Name (SAN) field to your VPN server’s DNS name or IP address:</p>
<div class="code-toolbar"><pre class="prefixed command language-bash"><code><ol><li data-prefix="$">pki <span class="token parameter variable">--pub</span> <span class="token parameter variable">--in</span> ~/pki/private/server-key.pem <span class="token parameter variable">--type</span> rsa <span class="token punctuation">\</span>
</li><li data-prefix="$">    <span class="token operator">|</span> pki <span class="token parameter variable">--issue</span> <span class="token parameter variable">--lifetime</span> <span class="token number">1825</span> <span class="token punctuation">\</span>
</li><li data-prefix="$">        <span class="token parameter variable">--cacert</span> ~/pki/cacerts/ca-cert.pem <span class="token punctuation">\</span>
</li><li data-prefix="$">        <span class="token parameter variable">--cakey</span> ~/pki/private/ca-key.pem <span class="token punctuation">\</span>
</li><li data-prefix="$">        <span class="token parameter variable">--dn</span> <span class="token string">"CN=<mark>server_domain_or_IP</mark>"</span> <span class="token parameter variable">--san</span> <mark>server_domain_or_IP</mark> <span class="token punctuation">\</span>
</li><li data-prefix="$">        <span class="token parameter variable">--flag</span> serverAuth <span class="token parameter variable">--flag</span> ikeIntermediate <span class="token parameter variable">--outform</span> pem <span class="token punctuation">\</span>
</li><li data-prefix="$">    <span class="token operator">&gt;</span>  ~/pki/certs/server-cert.pem
</li></ol>
</code></pre><div class="toolbar"><div class="toolbar-item"><button type="button">Copy</button></div></div></div>
<div class="callout note">
<p><strong>Note</strong>: If you are using an IP address instead of a DNS name, you will need to specify multiple <code>--san</code> entries. The line in the previous command block where you specify the distinguished name (<code>--dn ...</code>) will need to be modified with the extra entry like the following excerpted line:</p>
<pre><code>--dn "CN=<mark>IP address</mark>" --san @<mark>IP_address</mark> --san <mark>IP_address</mark> \
</code></pre>
<p>The reason for this extra <code>--san @<mark>IP_address</mark></code> entry is that some clients will check whether the TLS certificate has both an DNS entry and an IP Address entry for a server when they verify its identity.</p>
</div>
<p>The <code>--flag serverAuth</code> option is used to indicate that the certificate will be used explicitly for server authentication, before the encrypted tunnel is established. The <code>--flag ikeIntermediate</code> option is used to support older macOS clients.</p>
<p>Now that we’ve generated all of the TLS/SSL files StrongSwan needs, we can move the files into place in the <code>/etc/ipsec.d</code> directory by typing:</p>
<div class="code-toolbar"><pre class="prefixed command language-bash"><code><ol><li data-prefix="$"><span class="token function">sudo</span> <span class="token function">cp</span> <span class="token parameter variable">-r</span> ~/pki/* /etc/ipsec.d/
</li></ol>
</code></pre><div class="toolbar"><div class="toolbar-item"><button type="button">Copy</button></div></div></div>
<p>In this step, we’ve created a certificate pair that will be used to secure communications between the client and the server.  We’ve also signed the certificates with the CA key, so the client will be able to verify the authenticity of the VPN server using the CA certificate.  With all of these certificates ready, we’ll move on to configuring the software.</p>
<h2 id="step-4-configuring-strongswan"><a href="#step-4-configuring-strongswan" onclick="navigator.clipboard.writeText(this.href);">Step 4 — Configuring StrongSwan</a><a class="hash-anchor" href="#step-4-configuring-strongswan" aria-hidden="true" onclick="navigator.clipboard.writeText(this.href);"></a></h2>
<p>StrongSwan has a default configuration file with some examples, but we will have to do most of the configuration ourselves.  Let’s back up the file for reference before starting from scratch:</p>
<div class="code-toolbar"><pre class="prefixed command language-bash"><code><ol><li data-prefix="$"><span class="token function">sudo</span> <span class="token function">mv</span> /etc/ipsec.conf<span class="token punctuation">{</span>,.original<span class="token punctuation">}</span>
</li></ol>
</code></pre><div class="toolbar"><div class="toolbar-item"><button type="button">Copy</button></div></div></div>
<p>Create and open a new blank configuration file using your preferred text editor. Here, we’ll use <code>nano</code>:</p>
<div class="code-toolbar"><pre class="prefixed command language-bash"><code><ol><li data-prefix="$"><span class="token function">sudo</span> <span class="token function">nano</span> /etc/ipsec.conf
</li></ol>
</code></pre><div class="toolbar"><div class="toolbar-item"><button type="button">Copy</button></div></div></div>
<div class="callout note">
<p><strong>Note</strong>: As you work through this section to configure the server portion of your VPN, you will encounter settings that refer to <em>left</em> and <em>right</em> sides of a connection. When working with IPSec VPNs, the <em>left</em> side by convention refers to the local system that you are configuring, in this case the server. The right side directives in these settings will refer to remote clients, like phones and other computers.</p>
<p>When you move on to configuring clients later in this tutorial, the client configuration files will refer to themselves using various <em>left</em> directives, and the server will be referred to using <em>right</em> side terminology.</p>
</div>
<p>First, we’ll tell StrongSwan to log daemon statuses for debugging and allow duplicate connections.  Add these lines to the file:</p>
<div class="code-label" title="/etc/ipsec.conf">/etc/ipsec.conf</div>
<pre><code>config setup
    charondebug="ike 1, knl 1, cfg 0"
    uniqueids=no
</code></pre>
<p>Then, we’ll create a configuration section for our VPN.  We’ll also tell StrongSwan to create IKEv2 VPN Tunnels and to automatically load this configuration section when it starts up.  Append the following lines to the file:</p>
<div class="code-label" title="/etc/ipsec.conf">/etc/ipsec.conf</div>
<pre><code>. . .
conn ikev2-vpn
    auto=add
    compress=no
    type=tunnel
    keyexchange=ikev2
    fragmentation=yes
    forceencaps=yes
</code></pre>
<p>We’ll also configure dead-peer detection to clear any “dangling” connections in case the client unexpectedly disconnects.  Add these lines:</p>
<div class="code-label" title="/etc/ipsec.conf">/etc/ipsec.conf</div>
<pre><code>. . .
conn ikev2-vpn
    . . .
    dpdaction=clear
    dpddelay=300s
    rekey=no
</code></pre>
<p>Next, we’ll configure the server’s “left” side IPSec parameters. Each of the following parameters ensures that the server is configured to accept connections from clients and to identify itself correctly. You’ll add each of these settings to the <code>/etc/ipsec.conf</code> file once you are familiar with what they are and why they are used:</p>
<ul>
<li><code>left=%any</code> The <code>%any</code> value ensures that the server will use the network interface where it receives incoming connections for subsequent communication with clients. For example, if you are connecting a client over a private network, the server will use the private IP address where it receives traffic for the rest of the connection.</li>
<li><code>leftid=<mark>@server_domain_or_IP</mark></code> This option controls the name that the server presents to clients. When combined with the next option <code>leftcert</code>, the <code>leftid</code> option ensures that the server’s configured name and the Distinguished Name (DN) that is contained in the public certificate match.</li>
<li><code>leftcert=server-cert.pem</code> This option is the path to the public certificate for the server that you configured in Step 3. Without it, the server will not be able to authenticate itself with clients, or finish negotiating the IKEv2 set up.</li>
<li><code>leftsendcert=always</code> The <code>always</code> value ensures that any client that connects to the server will always receive a copy of the server’s public certificate as part of the initial connection set up.</li>
<li><code>leftsubnet=0.0.0.0/0</code> The last “left” side option that you will add tells clients about the subnets that are reachable behind the server. In this case, <code>0.0.0.0/0</code> is used to represent the entire set of IPv4 addresses, meaning that the server will tell clients to send all their traffic over the VPN by default.</li>
</ul>
<p>Now that you are familiar with each of the relevant “left” side options, add them all to the file like this:</p>
<div class="code-label" title="/etc/ipsec.conf">/etc/ipsec.conf</div>
<pre><code>. . .
conn ikev2-vpn
    . . .
    left=%any
    leftid=<mark>@server_domain_or_IP</mark>
    leftcert=server-cert.pem
    leftsendcert=always
    leftsubnet=0.0.0.0/0
</code></pre>
<div class="callout note">
<p><strong>Note</strong>: When configuring the server ID (<code>leftid</code>), only include the <code>@</code> character if your VPN server will be identified by a domain name:</p>
<div class="code-label" title="/etc/ipsec.conf">/etc/ipsec.conf</div>
<pre><code>    . . .    leftid=<mark>@vpn.example.com</mark>
    . . .
</code></pre>
<p>If the server will be identified by its IP address, just put the IP address in:</p>
<div class="code-label" title="/etc/ipsec.conf">/etc/ipsec.conf</div>
<pre><code>    . . .
    leftid=<mark>your_server_ip</mark>
    . . .
</code></pre>
</div>
<p>Next, we can configure the client’s “right” side IPSec parameters. Each of the following parameters tells the server how to accept connections from clients, how clients should authenticate to the server, and the private IP address ranges and DNS servers that clients will use. Add each of these settings to the <code>/etc/ipsec.conf</code> file once you are familiar with what they are and why they are used:</p>
<ul>
<li><code>right=%any</code> The <code>%any</code> option for the <code>right</code> side of the connection instructs the server to accept incoming connections from any remote client.</li>
<li><code>rightid=%any</code> This option ensures that the server will not reject connections from clients that provide an identity before the encrypted tunnel is established.</li>
<li><code>rightauth=eap-mschapv2</code> This option configures the authentication method that clients will use to authenticate to the server. <code>eap-mschapv2</code> is used here for broad compatibility to support clients like Windows, macOS, and Android devices.</li>
<li><code>rightsourceip=10.10.10.0/24</code> This option instructs the server to assign private IP addresses to clients from the specified <code>10.10.10.0/24</code> pool of IPs.</li>
<li><code>rightdns=8.8.8.8,8.8.4.4</code> These IP addresses are Google’s public DNS resolvers. They can be changed to use other public resolvers, the VPN server’s resolvers, or any other resolver that clients can reach.</li>
<li><code>rightsendcert=never</code> This option instructs the server that clients do not need to send a certificate to authenticate themselves.</li>
</ul>
<p>Now that you are familiar with the required “right” side options for the VPN, add the following lines to <code>/etc/ipsec.conf</code>:</p>
<div class="code-label" title="/etc/ipsec.conf">/etc/ipsec.conf</div>
<pre><code>. . .
conn ikev2-vpn
    . . .
    right=%any
    rightid=%any
    rightauth=eap-mschapv2
    rightsourceip=10.10.10.0/24
    rightdns=8.8.8.8,8.8.4.4
    rightsendcert=never
</code></pre>
<p>Now we’ll tell StrongSwan to ask the client for user credentials when they connect:</p>
<div class="code-label" title="/etc/ipsec.conf">/etc/ipsec.conf</div>
<pre><code>. . .
conn ikev2-vpn
    . . .
    eap_identity=%identity
</code></pre>
<p>Finally, add the following lines to support Linux, Windows, macOS, iOS, and Android clients. These lines specify the various key exchange, hashing, authentication, and encryption algorithms (commonly referred to as <em>Cipher Suites</em>) that StrongSwan will allow different clients to use:</p>
<div class="code-label" title="/etc/ipsec.conf">/etc/ipsec.conf</div>
<pre><code>. . .
conn ikev2-vpn
    . . .
    ike=chacha20poly1305-sha512-curve25519-prfsha512,aes256gcm16-sha384-prfsha384-ecp384,aes256-sha1-modp1024,aes128-sha1-modp1024,3des-sha1-modp1024!
    esp=chacha20poly1305-sha512,aes256gcm16-ecp384,aes256-sha256,aes256-sha1,3des-sha1!
</code></pre>
<p>Each supported cipher suite is delineated from the others by a comma. For example <code>chacha20poly1305-sha512-curve25519-prfsha512</code> is one suite, and <code>aes256gcm16-sha384-prfsha384-ecp384</code> is another. The cipher suites that are listed here are selected to ensure the widest range of compatibility across Windows, macOS, iOS, Android, and Linux clients.</p>
<p>The complete configuration file should look like this:</p>
<div class="code-label" title="/etc/ipsec.conf">/etc/ipsec.conf</div>
<pre><code>config setup
    charondebug="ike 1, knl 1, cfg 0"
    uniqueids=no

conn ikev2-vpn
    auto=add
    compress=no
    type=tunnel
    keyexchange=ikev2
    fragmentation=yes
    forceencaps=yes
    dpdaction=clear
    dpddelay=300s
    rekey=no
    left=%any
    leftid=<mark>@server_domain_or_IP</mark>
    leftcert=server-cert.pem
    leftsendcert=always
    leftsubnet=0.0.0.0/0
    right=%any
    rightid=%any
    rightauth=eap-mschapv2
    rightsourceip=10.10.10.0/24
    rightdns=8.8.8.8,8.8.4.4
    rightsendcert=never
    eap_identity=%identity
    ike=chacha20poly1305-sha512-curve25519-prfsha512,aes256gcm16-sha384-prfsha384-ecp384,aes256-sha1-modp1024,aes128-sha1-modp1024,3des-sha1-modp1024!
    esp=chacha20poly1305-sha512,aes256gcm16-ecp384,aes256-sha256,aes256-sha1,3des-sha1!
</code></pre>
<p>Save and close the file once you’ve verified that you’ve added each line correctly. If you used <code>nano</code>, do so by pressing <code>CTRL + X</code>, <code>Y</code>, then <code>ENTER</code>.</p>
<p>Now that we’ve configured the VPN parameters, let’s move on to creating an account so our users can connect to the server.</p>
<h2 id="step-5-configuring-vpn-authentication"><a href="#step-5-configuring-vpn-authentication" onclick="navigator.clipboard.writeText(this.href);">Step 5 — Configuring VPN Authentication</a><a class="hash-anchor" href="#step-5-configuring-vpn-authentication" aria-hidden="true" onclick="navigator.clipboard.writeText(this.href);"></a></h2>
<p>Our VPN server is now configured to accept client connections, but we don’t have any credentials configured yet.  We’ll need to configure a couple things in a special configuration file called <code>ipsec.secrets</code>:</p>
<ul>
<li>We need to tell StrongSwan where to find the private key for our server certificate, so the server will be able to authenticate to clients.</li>
<li>We also need to set up a list of users that will be allowed to connect to the VPN.</li>
</ul>
<p>Let’s open the secrets file for editing:</p>
<div class="code-toolbar"><pre class="prefixed command language-bash"><code><ol><li data-prefix="$"><span class="token function">sudo</span> <span class="token function">nano</span> /etc/ipsec.secrets
</li></ol>
</code></pre><div class="toolbar"><div class="toolbar-item"><button type="button">Copy</button></div></div></div>
<p>First, we’ll tell StrongSwan where to find our private key and how to parse it.</p>
<div class="code-label" title="/etc/ipsec.secrets">/etc/ipsec.secrets</div>
<pre><code>: RSA "server-key.pem"
</code></pre>
<p>Make sure that the line begins with the <code>:</code> character and that there is a space after it so that the entire line reads <code>: RSA "server-key.pem"</code>.</p>
<p>Then, we’ll define the user credentials.  You can make up any username or password combination that you like:</p>
<div class="code-label" title="/etc/ipsec.secrets">/etc/ipsec.secrets</div>
<pre><code><mark>your_username</mark> : EAP <mark>"your_password"</mark>
</code></pre>
<p>Save and close the file.  Now that we’ve finished working with the VPN parameters, we’ll restart the VPN service so that our configuration is applied:</p>
<div class="code-toolbar"><pre class="prefixed command language-bash"><code><ol><li data-prefix="$"><span class="token function">sudo</span> systemctl restart strongswan-starter
</li></ol>
</code></pre><div class="toolbar"><div class="toolbar-item"><button type="button">Copy</button></div></div></div>
<p>Now that the VPN server has been fully configured with both server options and user credentials, it’s time to move on to configuring the most important part: the firewall.</p>
<h2 id="step-6-configuring-the-firewall-kernel-ip-forwarding"><a href="#step-6-configuring-the-firewall-kernel-ip-forwarding" onclick="navigator.clipboard.writeText(this.href);">Step 6 — Configuring the Firewall &amp; Kernel IP Forwarding</a><a class="hash-anchor" href="#step-6-configuring-the-firewall-kernel-ip-forwarding" aria-hidden="true" onclick="navigator.clipboard.writeText(this.href);"></a></h2>
<p>With the StrongSwan configuration complete, we need to configure the firewall to allow VPN traffic through and forward it.</p>
<p>If you followed the prerequisite initial server setup tutorial, you should have a UFW firewall enabled.  If you don’t yet have UFW configured, you should start by adding a rule to allow SSH connections through the firewall so your current session doesn’t close when you enable UFW:</p>
<div class="code-toolbar"><pre class="prefixed command language-bash"><code><ol><li data-prefix="$"><span class="token function">sudo</span> ufw allow OpenSSH
</li></ol>
</code></pre><div class="toolbar"><div class="toolbar-item"><button type="button">Copy</button></div></div></div>
<p>Then enable the firewall by typing:</p>
<div class="code-toolbar"><pre class="prefixed command language-bash"><code><ol><li data-prefix="$"><span class="token function">sudo</span> ufw <span class="token builtin class-name">enable</span>
</li></ol>
</code></pre><div class="toolbar"><div class="toolbar-item"><button type="button">Copy</button></div></div></div>
<p>Then, add a rule to allow UDP traffic to the standard IPSec ports, <code>500</code> and <code>4500</code>:</p>
<div class="code-toolbar"><pre class="prefixed command language-bash"><code><ol><li data-prefix="$"><span class="token function">sudo</span> ufw allow <span class="token number">500,4500</span>/udp
</li></ol>
</code></pre><div class="toolbar"><div class="toolbar-item"><button type="button">Copy</button></div></div></div>
<p>Next, we will open up one of UFW’s configuration files to add a few low-level policies for routing and forwarding IPSec packets.  Before we we can do this, though, we need to find which network interface on our server is used for internet access.  Find this interface by querying for the device associated with the default route:</p>
<div class="code-toolbar"><pre class="prefixed command language-bash"><code><ol><li data-prefix="$"><span class="token function">ip</span> route show default
</li></ol>
</code></pre><div class="toolbar"><div class="toolbar-item"><button type="button">Copy</button></div></div></div>
<p>Your public interface should follow the word “dev”.  For example, this result shows the interface named <code>eth0</code>, which is highlighted in the following example:</p>
<pre><code><div class="secondary-code-label" title="Output">Output</div>default via <mark>your_server_ip</mark> dev <mark>eth0</mark> proto static
</code></pre>
<p>When you have your public network interface, open the <code>/etc/ufw/before.rules</code> file in your text editor. The rules in this file are added to the firewall before the rest of the usual input and output rules. They are used to configure network address translation (NAT) so that the server can correctly route connections to and from clients and the Internet.</p>
<div class="code-toolbar"><pre class="prefixed command language-bash"><code><ol><li data-prefix="$"><span class="token function">sudo</span> <span class="token function">nano</span> /etc/ufw/before.rules
</li></ol>
</code></pre><div class="toolbar"><div class="toolbar-item"><button type="button">Copy</button></div></div></div>
<p>Near the top of the file (before the <code>*filter</code> line), add the following configuration block. Change each instance of <code>eth0</code> in the above configuration to match the interface name you found with <code>ip route</code>.  The <code>*nat</code> lines create rules so that the firewall can correctly route and manipulate traffic between the VPN clients and the internet.  The <code>*mangle</code> line adjusts the maximum packet segment size to prevent potential issues with certain VPN clients:</p>
<div class="code-label" title="/etc/ufw/before.rules">/etc/ufw/before.rules</div>
<pre><code><mark>*nat</mark>
<mark>-A POSTROUTING -s 10.10.10.0/24 -o eth0 -m policy --pol ipsec --dir out -j ACCEPT</mark>
<mark>-A POSTROUTING -s 10.10.10.0/24 -o eth0 -j MASQUERADE</mark>
<mark>COMMIT</mark>

<mark>*mangle</mark>
<mark>-A FORWARD --match policy --pol ipsec --dir in -s 10.10.10.0/24 -o eth0 -p tcp -m tcp --tcp-flags SYN,RST SYN -m tcpmss --mss 1361:1536 -j TCPMSS --set-mss 1360</mark>
<mark>COMMIT</mark>

*filter
:ufw-before-input - [0:0]
:ufw-before-output - [0:0]
:ufw-before-forward - [0:0]
:ufw-not-local - [0:0]
. . .
</code></pre>
<p>Next, after the <code>*filter</code> and chain definition lines, add one more block of configuration:</p>
<div class="code-label" title="/etc/ufw/before.rules">/etc/ufw/before.rules</div>
<pre><code>. . .
*filter
:ufw-before-input - [0:0]
:ufw-before-output - [0:0]
:ufw-before-forward - [0:0]
:ufw-not-local - [0:0]

<mark>-A ufw-before-forward --match policy --pol ipsec --dir in --proto esp -s 10.10.10.0/24 -j ACCEPT</mark>
<mark>-A ufw-before-forward --match policy --pol ipsec --dir out --proto esp -d 10.10.10.0/24 -j ACCEPT</mark>
</code></pre>
<p>These lines tell the firewall to forward <a href="https://wiki.wireshark.org/ESP">ESP</a> (Encapsulating Security Payload) traffic so the VPN clients will be able to connect.  ESP provides additional security for our VPN packets as they’re traversing untrusted networks.</p>
<p>When you’re finished, ave and close the file once you’ve verified that you’ve added each line correctly. If you used <code>nano</code>, do so by pressing <code>CTRL + X</code>, <code>Y</code>, then <code>ENTER</code>.</p>
<p>Before restarting the firewall, we’ll change some network kernel parameters to allow routing from one interface to another. The file that controls these settings is called <code>/etc/ufw/sysctl.conf</code>. We’ll need to configure a few things in the file.</p>
<p>First IPv4 packet forwarding needs to be turned on so that traffic can move between the VPN and public facing network interfaces on the server. Next we’ll disable Path MTU discovery to prevent packet fragmentation problems. Finally we will not accept ICMP redirects nor send ICMP redirects to prevent <a href="https://en.wikipedia.org/wiki/Man-in-the-middle_attack">man-in-the-middle</a> attacks.</p>
<p>Open UFW’s kernel parameters configuration file using <code>nano</code> or your preferred text editor:</p>
<div class="code-toolbar"><pre class="prefixed command language-bash"><code><ol><li data-prefix="$"><span class="token function">sudo</span> <span class="token function">nano</span> /etc/ufw/sysctl.conf
</li></ol>
</code></pre><div class="toolbar"><div class="toolbar-item"><button type="button">Copy</button></div></div></div>
<p>Now add the following <code>net/ipv4/ip_forward=1</code> setting at the end of the file to enable forwarding packets between interfaces:</p>
<div class="code-label" title="/etc/ufw/sysctl.conf">/etc/ufw/sysctl.conf</div>
<pre><code>. . .
<mark>net/ipv4/ip_forward=1</mark>
</code></pre>
<p>Next block sending and receiving ICMP redirect packets by adding the following lines to the end of the file:</p>
<div class="code-label" title="/etc/ufw/sysctl.conf">/etc/ufw/sysctl.conf</div>
<pre><code>. . .
<mark>net/ipv4/conf/all/accept_redirects=0</mark>
<mark>net/ipv4/conf/all/send_redirects=0</mark>
</code></pre>
<p>Finally, turn off Path MTU discovery by adding this line to the end of the file:</p>
<div class="code-label" title="/etc/ufw/sysctl.conf">/etc/ufw/sysctl.conf</div>
<pre><code>. . .
<mark>net/ipv4/ip_no_pmtu_disc=1</mark>
</code></pre>
<p>Save the file when you are finished. Now we can enable all of our changes by disabling and re-enabling the firewall, since UFW applies these settings any time that it restarts:</p>
<div class="code-toolbar"><pre class="prefixed command language-bash"><code><ol><li data-prefix="$"><span class="token function">sudo</span> ufw disable
</li><li data-prefix="$"><span class="token function">sudo</span> ufw <span class="token builtin class-name">enable</span>
</li></ol>
</code></pre><div class="toolbar"><div class="toolbar-item"><button type="button">Copy</button></div></div></div>
<p>You’ll be prompted to confirm the process.  Type <code>Y</code> to enable UFW again with the new settings.</p>
<h2 id="step-7-testing-the-vpn-connection-on-windows-macos-ubuntu-ios-and-android"><a href="#step-7-testing-the-vpn-connection-on-windows-macos-ubuntu-ios-and-android" onclick="navigator.clipboard.writeText(this.href);">Step 7 — Testing the VPN Connection on Windows, macOS, Ubuntu, iOS, and Android</a><a class="hash-anchor" href="#step-7-testing-the-vpn-connection-on-windows-macos-ubuntu-ios-and-android" aria-hidden="true" onclick="navigator.clipboard.writeText(this.href);"></a></h2>
<p>Now that you have everything set up, it’s time to try it out.  First, you’ll need to copy the CA certificate you created and install it on your client device(s) that will connect to the VPN.  The easiest way to do this is to log into your server and output the contents of the certificate file:</p>
<div class="code-toolbar"><pre class="prefixed command language-bash"><code><ol><li data-prefix="$"><span class="token function">cat</span> /etc/ipsec.d/cacerts/ca-cert.pem
</li></ol>
</code></pre><div class="toolbar"><div class="toolbar-item"><button type="button">Copy</button></div></div></div>
<p>You’ll see output similar to this:</p>
<pre><code><div class="secondary-code-label" title="Output">Output</div>-----BEGIN CERTIFICATE-----
MIIFNDCCAxygAwIBAgIIHCsidG5mXzgwDQYJKoZIhvcNAQEMBQAwODELMAkGA1UE

. . .

H2YUdz8XNHrJHvMQKWFpi0rlEcMs+MSXPFWE3Q7UbaZJ/h8wpSldSUbQRUlphExJ
dJ4PX+MUJO/vjG1/ie6Kh25xbBAc3qNq8siiJZDwrg6vjEK7eiZ1rA==
-----END CERTIFICATE-----
</code></pre>
<p>Copy this output to your computer, including the <code>-----BEGIN CERTIFICATE-----</code> and   <code>-----END CERTIFICATE-----</code> lines, and save it to a file with a recognizable name, such as <code>ca-cert.pem</code>.  Ensure the file you create has the <code>.pem</code> extension.</p>
<p>Alternatively, <a href="https://www.digitalocean.com/community/tutorials/how-to-use-sftp-to-securely-transfer-files-with-a-remote-server">use SFTP to transfer the file to your computer</a>.</p>
<p>Once you have the <code>ca-cert.pem</code> file downloaded to your computer, you can set up the connection to the VPN.</p>
<h3 id="connecting-from-windows"><a href="#connecting-from-windows" onclick="navigator.clipboard.writeText(this.href);">Connecting from Windows</a><a class="hash-anchor" href="#connecting-from-windows" aria-hidden="true" onclick="navigator.clipboard.writeText(this.href);"></a></h3>
<p>There are multiple ways to import the root certificate and configure Windows to connect to a VPN. The first method uses graphical tools for each step. The second method uses PowerShell commands, which can be scripted and modified to suit your VPN configuration.</p>
<div class="callout note">
<p><strong>Note:</strong> These instructions have been tested on Windows 10 installations running versions 1903 and 1909.</p>
</div>
<h4 id="configuring-windows-with-graphical-tools">Configuring Windows with Graphical Tools</h4>
<p>First, import the root certificate by following these steps:</p>
<ol>
<li>
<p>Press <code>WINDOWS+R</code> to bring up the <strong>Run</strong> dialog, and enter <code>mmc.exe</code> to launch the Windows Management Console.</p>
</li>
<li>
<p>From the <strong>File</strong> menu, navigate to <strong>Add or Remove Snap-in</strong>, select <strong>Certificates</strong> from the list of available snap-ins, and click <strong>Add</strong>.</p>
</li>
<li>
<p>We want the VPN to work with any user, so select <strong>Computer Account</strong> and click <strong>Next</strong>.</p>
</li>
<li>
<p>We’re configuring things on the local computer, so select <strong>Local Computer</strong>, then click <strong>Finish</strong>.</p>
</li>
<li>
<p>Under the <strong>Console Root</strong> node, expand the <strong>Certificates (Local Computer)</strong> entry,  expand <strong>Trusted Root Certification Authorities</strong>, and then select the <strong>Certificates</strong> entry:
<img src="https://assets.digitalocean.com/articles/ikevpn_ubuntu_1604/4PN0vT6.png" alt="Certificates view"></p>
</li>
<li>
<p>From the <strong>Action</strong> menu, select <strong>All Tasks</strong> and click <strong>Import</strong> to display the Certificate Import Wizard. Click <strong>Next</strong> to move past the introduction.</p>
</li>
<li>
<p>On the <strong>File to Import</strong> screen, press the <strong>Browse</strong> button, ensure that you change the file type from “X.509 Certificate (<em>.cer;</em>.crt)” to “All Files (<em>.</em>)”, and select the <code>ca-cert.pem</code> file that you’ve saved. Then click <strong>Next</strong>.</p>
</li>
<li>
<p>Ensure that the <strong>Certificate Store</strong> is set to <strong>Trusted Root Certification Authorities</strong>, and click <strong>Next</strong>.</p>
</li>
<li>
<p>Click <strong>Finish</strong> to import the certificate.</p>
</li>
</ol>
<p>Then configure the VPN with these steps:</p>
<ol>
<li>Launch <strong>Control Panel</strong>, then navigate to the <strong>Network and Sharing Center</strong>.</li>
<li>Click on <strong>Set up a new connection or network</strong>, then select <strong>Connect to a workplace</strong>.</li>
<li>Select <strong>Use my Internet connection (VPN)</strong>.</li>
<li>Enter the VPN server details. Enter the server’s domain name or IP address in the <strong>Internet address</strong> field, then fill in <strong>Destination name</strong> with something that describes your VPN connection. Then click <strong>Done</strong>.</li>
</ol>
<h4 id="configuring-windows-using-powershell">Configuring Windows using PowerShell</h4>
<p>To import the root CA certificate using PowerShell, first open a PowerShell prompt with administrator privileges. To do so, right click the Start menu icon and select <code>Windows PowerShell (Admin)</code>. You can also open a command prompt as administrator and type <code>powershell</code>.</p>
<p>Next we’ll import the certificate using the <code>Import-Certificate</code> PowerShell cmdlet. In the following command, the first <code>-CertStoreLocation</code> argument will ensure that the certificate is imported into the computer’s <strong>Trusted Root Certification Authorities</strong> store so that all programs and users will be able to verify the VPN server’s certificate. The <code>-FilePath</code> argument should point to the location where you copied the certificate. In the following example the path is <code>C:\Users\sammy\Documents\ca-cert.pem</code>. Ensure that you edit the command to match the location that you used.</p>
<div class="code-toolbar"><pre class="prefixed custom_prefix environment-local language-bash"><code><ol><li data-prefix="PS C:\windows&amp;#92;system32>">Import-Certificate <span class="token variable"><span class="token variable">`</span>
</span></li><li data-prefix="PS C:\windows&amp;#92;system32>"><span class="token variable">    <span class="token parameter variable">-CertStoreLocation</span> cert:<span class="token punctuation">\</span>LocalMachine<span class="token punctuation">\</span>Root<span class="token punctuation">\</span> <span class="token variable">`</span></span>
</li><li data-prefix="PS C:\windows&amp;#92;system32>">    <span class="token parameter variable">-FilePath</span> <mark>C:<span class="token punctuation">\</span>users<span class="token punctuation">\</span>sammy<span class="token punctuation">\</span>Documents<span class="token punctuation">\</span>ca-cert.pem</mark>
</li></ol>
</code></pre><div class="toolbar"><div class="toolbar-item"><button type="button">Copy</button></div></div></div>
<p>The command will output something like the following:</p>
<pre class="environment-local"><code><div class="secondary-code-label" title="Output">Output</div>   PSParentPath: Microsoft.PowerShell.Security\Certificate::LocalMachine\Root

Thumbprint                                Subject
----------                                -------
DB00813B4087E9367861E8463A60CEA0ADC5F002  CN=VPN root CA
</code></pre>
<p>Now to configure the VPN using PowerShell, run the following command. Substitute your server’s DNS name or IP address on the <code>-ServerAddress</code> line. The various flags will ensure that Windows is correctly configured with the appropriate security parameters that match the options that you set in <code>/etc/ipsec.conf</code>.</p>
<div class="code-toolbar"><pre class="prefixed custom_prefix environment-local language-bash"><code><ol><li data-prefix="PS C:\windows&amp;#92;system32>">Add-VpnConnection <span class="token parameter variable">-Name</span> <span class="token string">"VPN Connection"</span> <span class="token variable"><span class="token variable">`</span>
</span></li><li data-prefix="PS C:\windows&amp;#92;system32>"><span class="token variable">    <span class="token parameter variable">-ServerAddress</span> <span class="token string">"<mark>server_domain_or_IP</mark>"</span> <span class="token variable">`</span></span>
</li><li data-prefix="PS C:\windows&amp;#92;system32>">    <span class="token parameter variable">-TunnelType</span> <span class="token string">"IKEv2"</span> <span class="token variable"><span class="token variable">`</span>
</span></li><li data-prefix="PS C:\windows&amp;#92;system32>"><span class="token variable">    <span class="token parameter variable">-AuthenticationMethod</span> <span class="token string">"EAP"</span> <span class="token variable">`</span></span>
</li><li data-prefix="PS C:\windows&amp;#92;system32>">    <span class="token parameter variable">-EncryptionLevel</span> <span class="token string">"Maximum"</span> <span class="token variable"><span class="token variable">`</span>
</span></li><li data-prefix="PS C:\windows&amp;#92;system32>"><span class="token variable">    <span class="token parameter variable">-RememberCredential</span> <span class="token variable">`</span></span>
</li></ol>
</code></pre><div class="toolbar"><div class="toolbar-item"><button type="button">Copy</button></div></div></div>
<p>If the command is successful there will not be any output. To confirm the VPN is configured correctly, use the <code>Get-VPNConnection</code> cmdlet:</p>
<div class="code-toolbar"><pre class="prefixed custom_prefix environment-local language-bash"><code><ol><li data-prefix="PS C:\windows&amp;#92;system32>">Get-VpnConnection <span class="token parameter variable">-Name</span> <span class="token string">"VPN Connection"</span>
</li></ol>
</code></pre><div class="toolbar"><div class="toolbar-item"><button type="button">Copy</button></div></div></div>
<p>You will receive output like the following:</p>
<pre class="environment-local"><code><div class="secondary-code-label" title="Output">Output</div>Name                  : VPN Connection
ServerAddress         : <mark>your_server_ip</mark>
AllUserConnection     : False
Guid                  : {B055A1AB-175C-4028-B4A8-D34309A2B20E}
TunnelType            : Ikev2
AuthenticationMethod  : {Eap}
EncryptionLevel       : Maximum
L2tpIPsecAuth         :
UseWinlogonCredential : False
EapConfigXmlStream    : #document
ConnectionStatus      : Disconnected
RememberCredential    : True
SplitTunneling        : False
DnsSuffix             :
IdleDisconnectSeconds : 0
</code></pre>
<p>By default Windows chooses older and slower algorithms. Run the <code>Set-VpnConnectionIPsecConfiguration</code> cmdlet to upgrade the encryption parameters that Windows will use for the IKEv2 key exchange, and to encrypt packets:</p>
<div class="code-toolbar"><pre class="prefixed custom_prefix environment-local language-bash"><code><ol><li data-prefix="PS C:\windows&amp;#92;system32>">Set-VpnConnectionIPsecConfiguration <span class="token parameter variable">-Name</span> <span class="token string">"VPN Connection"</span> <span class="token variable"><span class="token variable">`</span>
</span></li><li data-prefix="PS C:\windows&amp;#92;system32>"><span class="token variable">    <span class="token parameter variable">-AuthenticationTransformConstants</span> GCMAES256 <span class="token variable">`</span></span>
</li><li data-prefix="PS C:\windows&amp;#92;system32>">    <span class="token parameter variable">-CipherTransformConstants</span> GCMAES256 <span class="token variable"><span class="token variable">`</span>
</span></li><li data-prefix="PS C:\windows&amp;#92;system32>"><span class="token variable">    <span class="token parameter variable">-DHGroup</span> ECP384 <span class="token variable">`</span></span>
</li><li data-prefix="PS C:\windows&amp;#92;system32>">    <span class="token parameter variable">-IntegrityCheckMethod</span> SHA384 <span class="token variable"><span class="token variable">`</span>
</span></li><li data-prefix="PS C:\windows&amp;#92;system32>"><span class="token variable">    <span class="token parameter variable">-PfsGroup</span> ECP384 <span class="token variable">`</span></span>
</li><li data-prefix="PS C:\windows&amp;#92;system32>">    <span class="token parameter variable">-EncryptionMethod</span> GCMAES256
</li></ol>
</code></pre><div class="toolbar"><div class="toolbar-item"><button type="button">Copy</button></div></div></div>
<div class="callout note">
<p><strong>Note</strong>: If you would like to delete the VPN connection and reconfigure it with different options, you can run the <code>Remove-VpnConnection</code> cmdlet.</p>
<div class="code-toolbar"><pre class="prefixed custom_prefix environment-local language-bash"><code><ol><li data-prefix="PS C:\windows&amp;#92;system32>">Remove-VpnConnection <span class="token parameter variable">-Name</span> <span class="token string">"VPN Connection"</span> <span class="token parameter variable">-Force</span>
</li></ol>
</code></pre><div class="toolbar"><div class="toolbar-item"><button type="button">Copy</button></div></div></div>
<p>The <code>-Force</code> flag will skip prompting you to confirm the removal. You must be disconnected from the VPN if you attempt to remove it using this command.</p>
</div>
<h4 id="connecting-to-the-vpn">Connecting to the VPN</h4>
<p>Once you have the certificate imported and the VPN configured using either method, your new VPN connection will be visible under the list of networks. Select the VPN and click <strong>Connect</strong>.  You’ll be prompted for your username and password. Type them in, click <strong>OK</strong>, and you’ll be connected.</p>
<h3 id="connecting-from-macos"><a href="#connecting-from-macos" onclick="navigator.clipboard.writeText(this.href);">Connecting from macOS</a><a class="hash-anchor" href="#connecting-from-macos" aria-hidden="true" onclick="navigator.clipboard.writeText(this.href);"></a></h3>
<p>Follow these steps to import the certificate:</p>
<ol>
<li>Double-click the certificate file.  <strong>Keychain Access</strong> will pop up with a dialog that says “Keychain Access is trying to modify the system keychain. Enter your password to allow this.”</li>
<li>Enter your password, then click on <strong>Modify Keychain</strong></li>
<li>Double-click the newly imported VPN certificate. This brings up a small properties window where you can specify the trust levels.  Set <strong>IP Security (IPSec)</strong> to <strong>Always Trust</strong> and you’ll be prompted for your password again. This setting saves automatically after entering the password.</li>
</ol>
<p>Now that the certificate is imported and trusted, configure the VPN connection with these steps:</p>
<ol>
<li>Go to <strong>System Preferences</strong> and choose <strong>Network</strong>.</li>
<li>Click on the small “plus” button on the lower-left of the list of networks.</li>
<li>In the popup that appears, set <strong>Interface</strong> to <strong>VPN</strong>, set the <strong>VPN Type</strong> to  <strong>IKEv2</strong>,  and give the connection a name.</li>
<li>In the <strong>Server</strong> and <strong>Remote ID</strong> field, enter the server’s domain name or IP address.  Leave the <strong>Local ID</strong> blank.</li>
<li>Click on <strong>Authentication Settings</strong>, select <strong>Username</strong>,  and enter your username and password you configured for your VPN user. Then click <strong>OK</strong>.</li>
</ol>
<p>Finally, click on <strong>Connect</strong> to connect to the VPN. You should now be connected to the VPN.</p>
<h3 id="connecting-from-ubuntu"><a href="#connecting-from-ubuntu" onclick="navigator.clipboard.writeText(this.href);">Connecting from Ubuntu</a><a class="hash-anchor" href="#connecting-from-ubuntu" aria-hidden="true" onclick="navigator.clipboard.writeText(this.href);"></a></h3>
<p>To connect from an Ubuntu machine, you can set up and manage StrongSwan as a service or use a one-off command every time you wish to connect.  Instructions are provided for both.</p>
<h4 id="managing-strongswan-as-a-service">Managing StrongSwan as a Service</h4>
<p>To manage StrongSwan as a service, you will need to perform the following configuration steps.</p>
<p>First, update your local package cache using <code>apt</code></p>
<div class="code-toolbar"><pre class="prefixed command environment-local language-bash"><code><ol><li data-prefix="$"> <span class="token function">sudo</span> <span class="token function">apt</span> update
</li></ol>
</code></pre><div class="toolbar"><div class="toolbar-item"><button type="button">Copy</button></div></div></div>
<p>Next, install StrongSwan and the required plugins for authentication:</p>
<div class="code-toolbar"><pre class="prefixed command environment-local language-bash"><code><ol><li data-prefix="$"><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> strongswan libcharon-extra-plugins
</li></ol>
</code></pre><div class="toolbar"><div class="toolbar-item"><button type="button">Copy</button></div></div></div>
<p>Now you’ll need a copy of the CA certificate in the <code>/etc/ipsec.d/cacerts</code> directory so that your client can verify the server’s identity. Run the following command to copy the <code>ca-cert.pem</code> file into place:</p>
<div class="code-toolbar"><pre class="prefixed command environment-local language-bash"><code><ol><li data-prefix="$"><span class="token function">sudo</span> <span class="token function">cp</span> <mark>/tmp/ca-cert.pem</mark> /etc/ipsec.d/cacerts
</li></ol>
</code></pre><div class="toolbar"><div class="toolbar-item"><button type="button">Copy</button></div></div></div>
<p>To ensure the VPN only runs on demand, use <code>systemctl</code> to disable StrongSwan from running automatically:</p>
<div class="code-toolbar"><pre class="prefixed command environment-local language-bash"><code><ol><li data-prefix="$"><span class="token function">sudo</span> systemctl disable <span class="token parameter variable">--now</span> strongswan-starter
</li></ol>
</code></pre><div class="toolbar"><div class="toolbar-item"><button type="button">Copy</button></div></div></div>
<p>Next configure the username and password that you will use to authenticate to the VPN server. Edit <code>/etc/ipsec.secrets</code> using nano or your preferred editor:</p>
<div class="code-toolbar"><pre class="prefixed command environment-local language-bash"><code><ol><li data-prefix="$"><span class="token function">sudo</span> <span class="token function">nano</span> /etc/ipsec.secrets
</li></ol>
</code></pre><div class="toolbar"><div class="toolbar-item"><button type="button">Copy</button></div></div></div>
<p>Add the following line, editing the highlighted username and password values to match the ones that you configured on the server:</p>
<div class="code-label" title="/etc/ipsec.secrets">/etc/ipsec.secrets</div>
<pre class="environment-local"><code><mark>your_username</mark> : EAP <mark>"your_password"</mark>
</code></pre>
<p>Finally, edit the <code>/etc/ipsec.conf</code> file to configure your client to match the server’s configuration:</p>
<div class="code-label" title="/etc/ipsec.conf">/etc/ipsec.conf</div>
<pre class="environment-local"><code>config setup

conn ikev2-rw
    right=<mark>server_domain_or_IP</mark>
    # This should match the `leftid` value on your server's configuration
    rightid=<mark>server_domain_or_IP</mark>
    rightsubnet=0.0.0.0/0
    rightauth=pubkey
    leftsourceip=%config
    leftid=<mark>username</mark>
    leftauth=eap-mschapv2
    eap_identity=%identity
    auto=start
</code></pre>
<p>To connect to the VPN, type:</p>
<div class="code-toolbar"><pre class="prefixed command environment-local language-bash"><code><ol><li data-prefix="$"><span class="token function">sudo</span> systemctl start strongswan-starter
</li></ol>
</code></pre><div class="toolbar"><div class="toolbar-item"><button type="button">Copy</button></div></div></div>
<p>To disconnect again, type:</p>
<div class="code-toolbar"><pre class="prefixed command environment-local language-bash"><code><ol><li data-prefix="$"><span class="token function">sudo</span> systemctl stop strongswan-starter
</li></ol>
</code></pre><div class="toolbar"><div class="toolbar-item"><button type="button">Copy</button></div></div></div>
<h4 id="using-the-charon-cmd-client-for-one-off-connections">Using the <code>charon-cmd</code> Client for One-Off Connections</h4>
<p>To manage StrongSwan as a service, you will need to perform the following configuration steps.</p>
<p>First, update your local package cache using <code>apt</code></p>
<div class="code-toolbar"><pre class="prefixed command environment-local language-bash"><code><ol><li data-prefix="$"><span class="token function">sudo</span> <span class="token function">apt</span> update
</li></ol>
</code></pre><div class="toolbar"><div class="toolbar-item"><button type="button">Copy</button></div></div></div>
<p>Next, install StrongSwan and the required plugins for authentication:</p>
<div class="code-toolbar"><pre class="prefixed command environment-local language-bash"><code><ol><li data-prefix="$"><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> strongswan libcharon-extra-plugins
</li></ol>
</code></pre><div class="toolbar"><div class="toolbar-item"><button type="button">Copy</button></div></div></div>
<p>Now you’ll need a copy of the CA certificate in the <code>/etc/ipsec.d/cacerts</code> directory so that your client can verify the server’s identity. Run the following command to copy the <code>ca-cert.pem</code> file into place:</p>
<div class="code-toolbar"><pre class="prefixed command environment-local language-bash"><code><ol><li data-prefix="$"><span class="token function">sudo</span> <span class="token function">cp</span> <mark>/tmp/ca-cert.pem</mark> /etc/ipsec.d/cacerts
</li></ol>
</code></pre><div class="toolbar"><div class="toolbar-item"><button type="button">Copy</button></div></div></div>
<p>At this point you can connect to the VPN server with <code>charon-cmd</code> using the server’s CA certificate, the VPN server’s IP address, and the username you configured.</p>
<p>Run the following command whenever you want to connect to the VPN:</p>
<div class="code-toolbar"><pre class="prefixed command environment-local language-bash"><code><ol><li data-prefix="$"><span class="token function">sudo</span> charon-cmd <span class="token parameter variable">--cert</span> ca-cert.pem <span class="token parameter variable">--host</span> <mark>vpn_domain_or_IP</mark> <span class="token parameter variable">--identity</span> <mark>your_username</mark>
</li></ol>
</code></pre><div class="toolbar"><div class="toolbar-item"><button type="button">Copy</button></div></div></div>
<p>When prompted, provide the VPN user’s password and you will be connected to the VPN.  To disconnect, press <code>CTRL+C</code> in the terminal and wait for the connection to close.</p>
<h3 id="connecting-from-ios"><a href="#connecting-from-ios" onclick="navigator.clipboard.writeText(this.href);">Connecting from iOS</a><a class="hash-anchor" href="#connecting-from-ios" aria-hidden="true" onclick="navigator.clipboard.writeText(this.href);"></a></h3>
<p>To configure the VPN connection on an iOS device, follow these steps:</p>
<ol>
<li>Send yourself an email with the root certificate attached.</li>
<li>Open the email on your iOS device and tap on the attached certificate file, then tap <strong>Install</strong> and enter your passcode.  Once it installs, tap <strong>Done</strong>.</li>
<li>Go to <strong>Settings</strong>, <strong>General</strong>, <strong>VPN</strong> and tap <strong>Add VPN Configuration</strong>.  This will bring up the VPN connection configuration screen.</li>
<li>Tap on <strong>Type</strong> and select <strong>IKEv2</strong>.</li>
<li>In the <strong>Description</strong> field, enter a short name for the VPN connection.  This could be anything you like.</li>
<li>In the <strong>Server</strong> and <strong>Remote ID</strong> field, enter the server’s domain name or IP address.  The <strong>Local ID</strong> field can be left blank.</li>
<li>Enter your username and password in the <strong>Authentication</strong> section, then tap <strong>Done</strong>.</li>
<li>Select the VPN connection that you  just created, tap the switch on the top of the page, and you’ll be connected.</li>
</ol>
<h3 id="connecting-from-android"><a href="#connecting-from-android" onclick="navigator.clipboard.writeText(this.href);">Connecting from Android</a><a class="hash-anchor" href="#connecting-from-android" aria-hidden="true" onclick="navigator.clipboard.writeText(this.href);"></a></h3>
<p>Follow these steps to import the certificate:</p>
<ol>
<li>Send yourself an email with the CA certificate attached.  Save the CA certificate to your downloads folder.</li>
<li>Download the <a href="https://play.google.com/store/apps/details?id=org.strongswan.android&amp;hl=en_US">StrongSwan VPN client</a> from the Play Store.</li>
<li>Open the app.  Tap the “more” icon (<strong>. . .</strong>) in the upper-right corner  and select <strong>CA certificates</strong>.</li>
<li>Tap the “more” icon (<strong>. . .</strong>) in the upper-right corner again.  Select <strong>Import certificate</strong>.</li>
<li>Browse to the CA certificate file in your downloads folder and select it to import it into the app.</li>
</ol>
<p>Now that the certificate is imported into the StrongSwan app, you can configure the VPN connection with these steps:</p>
<ol>
<li>In the app, tap <strong>ADD VPN PROFILE</strong> at the top.</li>
<li>Fill out the <strong>Server</strong> with your VPN server’s domain name or public IP address.</li>
<li>Make sure <strong>IKEv2 EAP (Username/Password)</strong> is selected as the VPN Type.</li>
<li>Fill out the <strong>Username</strong> and <strong>Password</strong> with the credentials you defined on the server.</li>
<li>Deselect <strong>Select automatically</strong> in the <strong>CA certificate</strong> section and click <strong>Select CA certificate</strong>.</li>
<li>Tap the <strong>IMPORTED</strong> tab at the top of the screen and choose the CA you imported (it will be named “VPN root CA” if you didn’t change the “DN” earlier).</li>
<li>If you’d like, fill out <strong>Profile name (optional)</strong> with a more descriptive name.</li>
</ol>
<p>When you wish to connect to the VPN, click on the profile you just created in the StrongSwan application.</p>
<h3 id="troubleshooting-connections"><a href="#troubleshooting-connections" onclick="navigator.clipboard.writeText(this.href);">Troubleshooting Connections</a><a class="hash-anchor" href="#troubleshooting-connections" aria-hidden="true" onclick="navigator.clipboard.writeText(this.href);"></a></h3>
<p>If you are unable to import the certificate, ensure the file has the <code>.pem</code> extension, and not <code>.pem.txt</code>.</p>
<p>If you’re unable to connect to the VPN, check the server name or IP address you used.  The server’s domain name or IP address must match what you’ve configured as the common name (CN) while creating the certificate.  If they don’t match,  the VPN connection won’t work.  For example, if you set up a certificate with the CN of <code>vpn.example.com</code>, you <em>must</em> use <code>vpn.example.com</code> when you enter the VPN server details.  Double-check the command you used to generate the certificate, and the values you used when creating your VPN connection.</p>
<p>Finally, double-check the VPN configuration to ensure the <code>leftid</code> value is configured with the <code>@</code> symbol if you’re using a domain name:</p>
<div class="code-label" title="/etc/ipsec.conf">/etc/ipsec.conf</div>
<pre><code>    leftid=<mark>@</mark>vpn.example.com
</code></pre>
<p>If you’re using an IP address, ensure that the <code>@</code> symbol is omitted. Also make sure that when you generated the <code>server-cert.pem</code> file that you included both <code>--san @<mark>IP_address</mark></code> and <code>--san <mark>IP_address</mark></code> flags.</p>
<h2 id="conclusion"><a href="#conclusion" onclick="navigator.clipboard.writeText(this.href);">Conclusion</a><a class="hash-anchor" href="#conclusion" aria-hidden="true" onclick="navigator.clipboard.writeText(this.href);"></a></h2>
<p>In this tutorial, you’ve built a VPN server that uses the IKEv2 protocol. You learned about the directives that control the <code>left</code> and <code>right</code> sides of a connection on both server and clients. You also configured a Windows, macOS, iOS, Android, or Linux client to connect to the VPN.</p>
<p>To add or remove users, skip to Step 5 again. Each line in <code>/etc/ipsec.secrets</code> is for one user, so adding or removing users, or changing passwords just requires editing the file.</p>
<p>Now you can be assured that your online activities will remain secure wherever you go and with any device that you use to access the internet.</p>
</div>
